<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>VibeTime</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #e94560;
        }
        
        .clock {
            font-size: 4rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            margin: 10px 0;
            color: #fff;
        }
        
        .countdown {
            font-size: 1.2rem;
            color: #e94560;
            margin-bottom: 15px;
        }
        
        .countdown span {
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }
        
        .number-input {
            width: 70px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            text-align: center;
        }
        
        .number-input:focus {
            outline: none;
            border-color: #e94560;
        }
        
        .main-button {
            background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        
        .main-button:active {
            transform: scale(0.95);
        }
        
        .main-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .settings {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            width: 100%;
            max-width: 350px;
        }
        
        .settings h2 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #aaa;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-row:last-child {
            border-bottom: none;
        }
        
        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle input:checked + .toggle-slider {
            background-color: #e94560;
        }
        
        .toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .test-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .test-btn:active {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .help {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            width: 100%;
            max-width: 350px;
            font-size: 0.85rem;
            color: #aaa;
        }
        
        .help h3 {
            color: #ddd;
            margin-bottom: 10px;
        }
        
        .pattern-display {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            min-height: 40px;
            font-size: 0.9rem;
        }
        
        .status {
            color: #e94560;
            font-size: 0.9rem;
            margin-top: 10px;
            min-height: 20px;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #ffc107;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.85rem;
            text-align: center;
            max-width: 350px;
        }
    </style>
</head>
<body>
    <h1>‚è± VibeTime</h1>
    
    <div class="clock" id="clock">00:00:00</div>
    
    <div class="countdown">Next buzz in <span id="countdown">--:--</span></div>
    
    <button class="main-button" id="vibeBtn">Feel Current Time</button>
    
    <div class="status" id="status"></div>
    
    <div id="warning" class="warning" style="display: none;">
        Vibration API not supported. Try Chrome or Firefox on Android.
    </div>
    
    <div class="settings">
        <h2>SETTINGS</h2>
        
        <div class="setting-row">
            <span>12-hour format</span>
            <label class="toggle">
                <input type="checkbox" id="format12">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-row">
            <span>Buzz interval (min)</span>
            <input type="number" id="buzzInterval" class="number-input" value="5" min="1" max="60">
        </div>
        
        <div class="setting-row">
            <span>Start minute</span>
            <input type="number" id="startMinute" class="number-input" value="0" min="0" max="59">
        </div>
        
        <div class="setting-row">
            <span>Audible beeps</span>
            <label class="toggle">
                <input type="checkbox" id="audioEnabled">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-row">
            <span>Tally base</span>
            <select id="tallyBase" class="number-input" style="width: 80px;">
                <option value="5" selected>5</option>
                <option value="10">10</option>
            </select>
        </div>
    </div>
    
    <div class="settings">
        <h2>TEST TIMES</h2>
        <div class="test-buttons">
            <button class="test-btn" data-hour="0" data-minute="0">00:00</button>
            <button class="test-btn" data-hour="8" data-minute="5">08:05</button>
            <button class="test-btn" data-hour="14" data-minute="37">14:37</button>
            <button class="test-btn" data-hour="23" data-minute="59">23:59</button>
        </div>
        <div class="pattern-display" id="patternDisplay">Tap a time to see pattern</div>
    </div>
    
    <div class="help">
        <h3>How it works</h3>
        <p>Time is encoded as vibrations:</p>
        <p><strong>LONG (250ms)</strong> = <span id="helpBase">5</span> units</p>
        <p><strong>SHORT (100ms)</strong> = 1 unit</p>
        <p id="helpExample">Example: 14 = 2 LONG + 4 SHORT</p>
    </div>
    
    <script>
        // Timing constants (ms)
        const LONG_PULSE = 250;
        const SHORT_PULSE = 100;
        const INTER_PULSE_PAUSE = 70;
        const SEPARATOR_PAUSE = 400;
        
        // State
        let isVibrating = false;
        
        // Elements
        const clockEl = document.getElementById('clock');
        const countdownEl = document.getElementById('countdown');
        const vibeBtn = document.getElementById('vibeBtn');
        const statusEl = document.getElementById('status');
        const patternEl = document.getElementById('patternDisplay');
        const warningEl = document.getElementById('warning');
        const format12El = document.getElementById('format12');
        const buzzIntervalEl = document.getElementById('buzzInterval');
        const startMinuteEl = document.getElementById('startMinute');
        const audioEnabledEl = document.getElementById('audioEnabled');
        const tallyBaseEl = document.getElementById('tallyBase');
        
        // Get current tally base
        function getTallyBase() {
            return parseInt(tallyBaseEl.value) || 5;
        }
        
        // Audio context for beeps
        let audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        }
        
        // Play a beep tone
        function playBeep(frequency, duration) {
            const ctx = getAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration / 1000);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + duration / 1000);
        }
        
        // Check vibration support
        const canVibrate = 'vibrate' in navigator;
        if (!canVibrate) {
            warningEl.style.display = 'block';
        }
        
        // Format time for display (respects 12h setting)
        function formatTime(hours, minutes, seconds) {
            let h = hours;
            let suffix = '';
            
            if (format12El.checked) {
                suffix = h >= 12 ? ' PM' : ' AM';
                if (h === 0) h = 12;
                else if (h > 12) h -= 12;
            }
            
            const hStr = String(h).padStart(2, '0');
            const mStr = String(minutes).padStart(2, '0');
            const sStr = String(seconds).padStart(2, '0');
            return `${hStr}:${mStr}:${sStr}${suffix}`;
        }
        
        // Calculate next buzz time
        function getNextBuzzMinute(currentMinute, interval, startMinute) {
            // Find the next minute >= currentMinute that matches the pattern
            for (let m = currentMinute; m < 60; m++) {
                if ((m - startMinute) % interval === 0 && m >= startMinute) {
                    return m;
                }
            }
            // Next hour, start from startMinute
            return startMinute + 60; // indicates next hour
        }
        
        // Calculate countdown to next buzz
        function getCountdown(now) {
            const interval = parseInt(buzzIntervalEl.value) || 5;
            const startMin = parseInt(startMinuteEl.value) || 0;
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            let nextBuzzMinute = getNextBuzzMinute(currentMinute, interval, startMin);
            
            // If we're exactly on a buzz minute, show next one (unless at second 0)
            if (nextBuzzMinute === currentMinute && currentSecond > 0) {
                nextBuzzMinute = getNextBuzzMinute(currentMinute + 1, interval, startMin);
            }
            
            let minutesLeft, secondsLeft;
            
            if (nextBuzzMinute >= 60) {
                // Next hour
                minutesLeft = (60 - currentMinute - 1) + (nextBuzzMinute - 60);
                secondsLeft = 60 - currentSecond;
                if (secondsLeft === 60) {
                    secondsLeft = 0;
                    minutesLeft++;
                }
            } else {
                minutesLeft = nextBuzzMinute - currentMinute - 1;
                secondsLeft = 60 - currentSecond;
                if (secondsLeft === 60) {
                    secondsLeft = 0;
                    minutesLeft++;
                }
            }
            
            return { minutes: minutesLeft, seconds: secondsLeft };
        }
        
        // Check if it's time to buzz
        function shouldBuzzNow(now) {
            const interval = parseInt(buzzIntervalEl.value) || 5;
            const startMin = parseInt(startMinuteEl.value) || 0;
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            // Only buzz at second 0
            if (currentSecond !== 0) return false;
            
            // Check if current minute matches the pattern
            if (currentMinute < startMin) return false;
            return (currentMinute - startMin) % interval === 0;
        }
        
        // Update clock and countdown display
        function updateDisplay() {
            const now = new Date();
            clockEl.textContent = formatTime(now.getHours(), now.getMinutes(), now.getSeconds());
            
            const countdown = getCountdown(now);
            const minStr = String(countdown.minutes).padStart(2, '0');
            const secStr = String(countdown.seconds).padStart(2, '0');
            countdownEl.textContent = `${minStr}:${secStr}`;
            
            // Trigger automatic buzz at scheduled times
            if (shouldBuzzNow(now) && !isVibrating) {
                vibrateTime(now.getHours(), now.getMinutes());
            }
        }
        
        setInterval(updateDisplay, 1000);
        updateDisplay();
        
        // Build pattern for a number using tally system
        function buildNumberPattern(n) {
            if (n === 0) return [];
            
            const base = getTallyBase();
            const pattern = [];
            const longs = Math.floor(n / base);
            const shorts = n % base;
            
            // Add LONG pulses
            for (let i = 0; i < longs; i++) {
                if (pattern.length > 0) pattern.push(INTER_PULSE_PAUSE);
                pattern.push(LONG_PULSE);
            }
            
            // Add SHORT pulses
            for (let i = 0; i < shorts; i++) {
                if (pattern.length > 0) pattern.push(INTER_PULSE_PAUSE);
                pattern.push(SHORT_PULSE);
            }
            
            return pattern;
        }
        
        // Build complete time pattern (always includes both hour and minute)
        function buildTimePattern(hour, minute) {
            const hourPattern = buildNumberPattern(hour);
            const minutePattern = buildNumberPattern(minute);
            
            const fullPattern = [];
            
            if (hourPattern.length > 0) {
                fullPattern.push(...hourPattern);
            }
            
            if (minutePattern.length > 0) {
                if (fullPattern.length > 0) {
                    fullPattern.push(SEPARATOR_PAUSE);
                }
                fullPattern.push(...minutePattern);
            }
            
            return fullPattern;
        }
        
        // Describe pattern for display
        function describePattern(hour, minute) {
            const base = getTallyBase();
            const desc = [];
            
            const hLongs = Math.floor(hour / base);
            const hShorts = hour % base;
            const hParts = [];
            if (hLongs > 0) hParts.push(`${hLongs}L`);
            if (hShorts > 0) hParts.push(`${hShorts}S`);
            desc.push(`Hour ${hour}: ${hParts.length ? hParts.join('+') : '(none)'}`);
            
            const mLongs = Math.floor(minute / base);
            const mShorts = minute % base;
            const mParts = [];
            if (mLongs > 0) mParts.push(`${mLongs}L`);
            if (mShorts > 0) mParts.push(`${mShorts}S`);
            desc.push(`Min ${minute}: ${mParts.length ? mParts.join('+') : '(none)'}`);
            
            return desc.join(' | ');
        }
        
        // Play audio pattern using beeps
        async function playAudioPattern(hour, minute) {
            const base = getTallyBase();
            const longs_h = Math.floor(hour / base);
            const shorts_h = hour % base;
            const longs_m = Math.floor(minute / base);
            const shorts_m = minute % base;
            
            // Play hour
            for (let i = 0; i < longs_h; i++) {
                if (i > 0) await new Promise(r => setTimeout(r, INTER_PULSE_PAUSE));
                playBeep(440, LONG_PULSE); // A4 for long
                await new Promise(r => setTimeout(r, LONG_PULSE));
            }
            for (let i = 0; i < shorts_h; i++) {
                if (i > 0 || longs_h > 0) await new Promise(r => setTimeout(r, INTER_PULSE_PAUSE));
                playBeep(880, SHORT_PULSE); // A5 for short
                await new Promise(r => setTimeout(r, SHORT_PULSE));
            }
            
            // Separator
            if ((longs_h > 0 || shorts_h > 0) && (longs_m > 0 || shorts_m > 0)) {
                await new Promise(r => setTimeout(r, SEPARATOR_PAUSE));
            }
            
            // Play minute
            for (let i = 0; i < longs_m; i++) {
                if (i > 0) await new Promise(r => setTimeout(r, INTER_PULSE_PAUSE));
                playBeep(440, LONG_PULSE);
                await new Promise(r => setTimeout(r, LONG_PULSE));
            }
            for (let i = 0; i < shorts_m; i++) {
                if (i > 0 || longs_m > 0) await new Promise(r => setTimeout(r, INTER_PULSE_PAUSE));
                playBeep(880, SHORT_PULSE);
                await new Promise(r => setTimeout(r, SHORT_PULSE));
            }
        }
        
        // Vibrate time
        async function vibrateTime(hour, minute) {
            if (isVibrating) return;
            
            const pattern = buildTimePattern(hour, minute);
            
            if (pattern.length === 0) {
                statusEl.textContent = 'No vibration (00:00)';
                setTimeout(() => { statusEl.textContent = ''; }, 2000);
                return;
            }
            
            isVibrating = true;
            vibeBtn.disabled = true;
            statusEl.textContent = 'Playing...';
            
            // Start vibration if supported
            if (canVibrate) {
                navigator.vibrate(pattern);
            }
            
            // Play audio if enabled
            if (audioEnabledEl.checked) {
                await playAudioPattern(hour, minute);
            } else {
                const totalDuration = pattern.reduce((a, b) => a + b, 0);
                await new Promise(resolve => setTimeout(resolve, totalDuration));
            }
            
            isVibrating = false;
            vibeBtn.disabled = false;
            statusEl.textContent = '';
        }
        
        // Event listeners
        vibeBtn.addEventListener('click', () => {
            const now = new Date();
            vibrateTime(now.getHours(), now.getMinutes());
        });
        
        document.querySelectorAll('.test-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const hour = parseInt(btn.dataset.hour);
                const minute = parseInt(btn.dataset.minute);
                patternEl.textContent = describePattern(hour, minute);
                vibrateTime(hour, minute);
            });
        });
        
        // Update display when 12h format changes
        format12El.addEventListener('change', updateDisplay);
        
        // Update help text when tally base changes
        const helpBaseEl = document.getElementById('helpBase');
        const helpExampleEl = document.getElementById('helpExample');
        tallyBaseEl.addEventListener('change', () => {
            const base = getTallyBase();
            helpBaseEl.textContent = base;
            const longs = Math.floor(14 / base);
            const shorts = 14 % base;
            helpExampleEl.textContent = `Example: 14 = ${longs} LONG + ${shorts} SHORT`;
        });
    </script>
</body>
</html>
